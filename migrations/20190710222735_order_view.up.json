[
  {
    "create": "order_view",
    "viewOn": "order",
    "pipeline": [
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "real_gross_revenue"
              }
            },
            {
              "$project": {
                "amount": "$local_amount",
                "currency": "$local_currency",
                "_id": 0
              }
            }
          ],
          "as": "payment_gross_revenue_local"
        }
      },
      {
        "$unwind": {
          "path": "$payment_gross_revenue_local",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "real_gross_revenue"
              }
            },
            {
              "$project": {
                "amount": "$original_amount",
                "currency": "$original_currency",
                "_id": 0
              }
            }
          ],
          "as": "payment_gross_revenue_origin"
        }
      },
      {
        "$unwind": {
          "path": "$payment_gross_revenue_origin",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "real_gross_revenue"
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "payment_gross_revenue"
        }
      },
      {
        "$unwind": {
          "path": "$payment_gross_revenue",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "real_tax_fee"
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "payment_tax_fee"
        }
      },
      {
        "$unwind": {
          "path": "$payment_tax_fee",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "real_tax_fee"
              }
            },
            {
              "$project": {
                "amount": "$local_amount",
                "currency": "$local_currency",
                "_id": 0
              }
            }
          ],
          "as": "payment_tax_fee_local"
        }
      },
      {
        "$unwind": {
          "path": "$payment_tax_fee_local",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "real_tax_fee"
              }
            },
            {
              "$project": {
                "amount": "$original_amount",
                "currency": "$original_currency",
                "_id": 0
              }
            }
          ],
          "as": "payment_tax_fee_origin"
        }
      },
      {
        "$unwind": {
          "path": "$payment_tax_fee_origin",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "central_bank_tax_fee"
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "payment_tax_fee_current_exchange_fee"
        }
      },
      {
        "$unwind": {
          "path": "$payment_tax_fee_current_exchange_fee",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "ps_gross_revenue_fx"
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "payment_gross_revenue_fx"
        }
      },
      {
        "$unwind": {
          "path": "$payment_gross_revenue_fx",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "ps_gross_revenue_fx_tax_fee"
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "payment_gross_revenue_fx_tax_fee"
        }
      },
      {
        "$unwind": {
          "path": "$payment_gross_revenue_fx_tax_fee",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "merchant_tax_fee_cost_value"
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "tax_fee"
        }
      },
      {
        "$unwind": {
          "path": "$tax_fee",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "merchant_tax_fee_central_bank_fx"
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "tax_fee_currency_exchange_fee"
        }
      },
      {
        "$unwind": {
          "path": "$tax_fee_currency_exchange_fee",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "ps_method_fee"
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "method_fee_total"
        }
      },
      {
        "$unwind": {
          "path": "$method_fee_total",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "merchant_method_fee"
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "method_fee_tariff"
        }
      },
      {
        "$unwind": {
          "path": "$method_fee_tariff",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "merchant_method_fee_cost_value"
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "paysuper_method_fee_tariff_self_cost"
        }
      },
      {
        "$unwind": {
          "path": "$paysuper_method_fee_tariff_self_cost",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "merchant_method_fixed_fee"
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "method_fixed_fee_tariff"
        }
      },
      {
        "$unwind": {
          "path": "$method_fixed_fee_tariff",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "real_merchant_method_fixed_fee_cost_value"
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "paysuper_method_fixed_fee_tariff_self_cost"
        }
      },
      {
        "$unwind": {
          "path": "$paysuper_method_fixed_fee_tariff_self_cost",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "merchant_ps_fixed_fee"
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "paysuper_fixed_fee"
        }
      },
      {
        "$unwind": {
          "path": "$paysuper_fixed_fee",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "real_refund"
              }
            },
            {
              "$project": {
                "amount": "$local_amount",
                "currency": "$local_currency",
                "_id": 0
              }
            }
          ],
          "as": "payment_refund_gross_revenue_local"
        }
      },
      {
        "$unwind": {
          "path": "$payment_refund_gross_revenue_local",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "real_refund"
              }
            },
            {
              "$project": {
                "amount": "$original_amount",
                "currency": "$original_currency",
                "_id": 0
              }
            }
          ],
          "as": "payment_refund_gross_revenue_origin"
        }
      },
      {
        "$unwind": {
          "path": "$payment_refund_gross_revenue_origin",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "real_refund"
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "payment_refund_gross_revenue"
        }
      },
      {
        "$unwind": {
          "path": "$payment_refund_gross_revenue",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "real_refund_tax_fee"
              }
            },
            {
              "$project": {
                "amount": "$local_amount",
                "currency": "$local_currency",
                "_id": 0
              }
            }
          ],
          "as": "payment_refund_tax_fee_local"
        }
      },
      {
        "$unwind": {
          "path": "$payment_refund_tax_fee_local",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "real_refund_tax_fee"
              }
            },
            {
              "$project": {
                "amount": "$original_amount",
                "currency": "$original_currency",
                "_id": 0
              }
            }
          ],
          "as": "payment_refund_tax_fee_origin"
        }
      },
      {
        "$unwind": {
          "path": "$payment_refund_tax_fee_origin",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "real_refund_tax_fee"
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "payment_refund_tax_fee"
        }
      },
      {
        "$unwind": {
          "path": "$payment_refund_tax_fee",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "real_refund_fee"
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "payment_refund_fee_tariff"
        }
      },
      {
        "$unwind": {
          "path": "$payment_refund_fee_tariff",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "real_refund_fixed_fee"
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "method_refund_fixed_fee_tariff"
        }
      },
      {
        "$unwind": {
          "path": "$method_refund_fixed_fee_tariff",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "merchant_refund"
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "refund_gross_revenue"
        }
      },
      {
        "$unwind": {
          "path": "$refund_gross_revenue",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "merchant_refund_fee"
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "method_refund_fee_tariff"
        }
      },
      {
        "$unwind": {
          "path": "$method_refund_fee_tariff",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "merchant_refund_fixed_fee_cost_value"
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "paysuper_method_refund_fixed_fee_tariff_self_cost"
        }
      },
      {
        "$unwind": {
          "path": "$paysuper_method_refund_fixed_fee_tariff_self_cost",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "merchant_refund_fixed_fee"
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "merchant_refund_fixed_fee_tariff"
        }
      },
      {
        "$unwind": {
          "path": "$merchant_refund_fixed_fee_tariff",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "reverse_tax_fee"
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "refund_tax_fee"
        }
      },
      {
        "$unwind": {
          "path": "$refund_tax_fee",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "reverse_tax_fee_delta"
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "refund_tax_fee_currency_exchange_fee"
        }
      },
      {
        "$unwind": {
          "path": "$refund_tax_fee_currency_exchange_fee",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": "ps_reverse_tax_fee_delta"
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "paysuper_refund_tax_fee_currency_exchange_fee"
        }
      },
      {
        "$unwind": {
          "path": "$paysuper_refund_tax_fee_currency_exchange_fee",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": {
                  "$in": [
                    "real_tax_fee",
                    "central_bank_tax_fee"
                  ]
                }
              }
            },
            {
              "$group": {
                "_id": "$currency",
                "amount": {
                  "$sum": "$amount"
                },
                "currency": {
                  "$first": "$currency"
                }
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "payment_tax_fee_total"
        }
      },
      {
        "$unwind": {
          "path": "$payment_tax_fee_total",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": {
                  "$in": [
                    "merchant_tax_fee_cost_value",
                    "merchant_tax_fee_central_bank_fx"
                  ]
                }
              }
            },
            {
              "$group": {
                "_id": "$currency",
                "amount": {
                  "$sum": "$amount"
                },
                "currency": {
                  "$first": "$currency"
                }
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "tax_fee_total"
        }
      },
      {
        "$unwind": {
          "path": "$tax_fee_total",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": {
                  "$in": [
                    "reverse_tax_fee",
                    "reverse_tax_fee_delta"
                  ]
                }
              }
            },
            {
              "$group": {
                "_id": "$currency",
                "amount": {
                  "$sum": "$amount"
                },
                "currency": {
                  "$first": "$currency"
                }
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "refund_tax_fee_total"
        }
      },
      {
        "$unwind": {
          "path": "$refund_tax_fee_total",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": {
                  "$in": [
                    "ps_method_fee",
                    "merchant_ps_fixed_fee"
                  ]
                }
              }
            },
            {
              "$group": {
                "_id": "$currency",
                "amount": {
                  "$sum": "$amount"
                },
                "currency": {
                  "$first": "$currency"
                }
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "fees_total"
        }
      },
      {
        "$unwind": {
          "path": "$fees_total",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": {
                  "$in": [
                    "merchant_refund_fee",
                    "merchant_refund_fixed_fee"
                  ]
                }
              }
            },
            {
              "$group": {
                "_id": "$currency",
                "amount": {
                  "$sum": "$amount"
                },
                "currency": {
                  "$first": "$currency"
                }
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "refund_fees_total"
        }
      },
      {
        "$unwind": {
          "path": "$refund_fees_total",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": {
                  "$in": [
                    "ps_gross_revenue_fx",
                    "ps_gross_revenue_fx_tax_fee"
                  ]
                }
              }
            },
            {
              "$group": {
                "_id": "$currency",
                "amount": {
                  "$sum": {
                    "$cond": [
                      {
                        "$eq": [
                          "$type",
                          "ps_gross_revenue_fx_tax_fee"
                        ]
                      },
                      {
                        "$subtract": [
                          0,
                          "$amount"
                        ]
                      },
                      "$amount"
                    ]
                  }
                },
                "currency": {
                  "$first": "$currency"
                }
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "payment_gross_revenue_fx_profit"
        }
      },
      {
        "$unwind": {
          "path": "$payment_gross_revenue_fx_profit",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": {
                  "$in": [
                    "real_gross_revenue",
                    "ps_gross_revenue_fx"
                  ]
                }
              }
            },
            {
              "$group": {
                "_id": "$currency",
                "amount": {
                  "$sum": {
                    "$cond": [
                      {
                        "$eq": [
                          "$type",
                          "ps_gross_revenue_fx"
                        ]
                      },
                      {
                        "$subtract": [
                          0,
                          "$amount"
                        ]
                      },
                      "$amount"
                    ]
                  }
                },
                "currency": {
                  "$first": "$currency"
                }
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "gross_revenue"
        }
      },
      {
        "$unwind": {
          "path": "$gross_revenue",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": {
                  "$in": [
                    "merchant_method_fee",
                    "merchant_method_fee_cost_value"
                  ]
                }
              }
            },
            {
              "$group": {
                "_id": "$currency",
                "amount": {
                  "$sum": {
                    "$cond": [
                      {
                        "$eq": [
                          "$type",
                          "merchant_method_fee_cost_value"
                        ]
                      },
                      {
                        "$subtract": [
                          0,
                          "$amount"
                        ]
                      },
                      "$amount"
                    ]
                  }
                },
                "currency": {
                  "$first": "$currency"
                }
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "paysuper_method_fee_profit"
        }
      },
      {
        "$unwind": {
          "path": "$paysuper_method_fee_profit",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": {
                  "$in": [
                    "merchant_method_fixed_fee",
                    "real_merchant_method_fixed_fee"
                  ]
                }
              }
            },
            {
              "$group": {
                "_id": "$currency",
                "amount": {
                  "$sum": {
                    "$cond": [
                      {
                        "$eq": [
                          "$type",
                          "real_merchant_method_fixed_fee"
                        ]
                      },
                      {
                        "$subtract": [
                          0,
                          "$amount"
                        ]
                      },
                      "$amount"
                    ]
                  }
                },
                "currency": {
                  "$first": "$currency"
                }
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "paysuper_method_fixed_fee_tariff_fx_profit"
        }
      },
      {
        "$unwind": {
          "path": "$paysuper_method_fixed_fee_tariff_fx_profit",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": {
                  "$in": [
                    "real_merchant_method_fixed_fee",
                    "real_merchant_method_fixed_fee_cost_value"
                  ]
                }
              }
            },
            {
              "$group": {
                "_id": "$currency",
                "amount": {
                  "$sum": {
                    "$cond": [
                      {
                        "$eq": [
                          "$type",
                          "real_merchant_method_fixed_fee_cost_value"
                        ]
                      },
                      {
                        "$subtract": [
                          0,
                          "$amount"
                        ]
                      },
                      "$amount"
                    ]
                  }
                },
                "currency": {
                  "$first": "$currency"
                }
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "paysuper_method_fixed_fee_tariff_total_profit"
        }
      },
      {
        "$unwind": {
          "path": "$paysuper_method_fixed_fee_tariff_total_profit",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": {
                  "$in": [
                    "merchant_ps_fixed_fee",
                    "real_merchant_ps_fixed_fee"
                  ]
                }
              }
            },
            {
              "$group": {
                "_id": "$currency",
                "amount": {
                  "$sum": {
                    "$cond": [
                      {
                        "$eq": [
                          "$type",
                          "real_merchant_ps_fixed_fee"
                        ]
                      },
                      {
                        "$subtract": [
                          0,
                          "$amount"
                        ]
                      },
                      "$amount"
                    ]
                  }
                },
                "currency": {
                  "$first": "$currency"
                }
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "paysuper_fixed_fee_fx_profit"
        }
      },
      {
        "$unwind": {
          "path": "$paysuper_fixed_fee_fx_profit",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": {
                  "$in": [
                    "merchant_refund",
                    "real_refund"
                  ]
                }
              }
            },
            {
              "$group": {
                "_id": "$currency",
                "amount": {
                  "$sum": {
                    "$cond": [
                      {
                        "$eq": [
                          "$type",
                          "real_refund"
                        ]
                      },
                      {
                        "$subtract": [
                          0,
                          "$amount"
                        ]
                      },
                      "$amount"
                    ]
                  }
                },
                "currency": {
                  "$first": "$currency"
                }
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "refund_gross_revenue_fx"
        }
      },
      {
        "$unwind": {
          "path": "$refund_gross_revenue_fx",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": {
                  "$in": [
                    "merchant_refund_fee",
                    "real_refund_fee"
                  ]
                }
              }
            },
            {
              "$group": {
                "_id": "$currency",
                "amount": {
                  "$sum": {
                    "$cond": [
                      {
                        "$eq": [
                          "$type",
                          "real_refund_fee"
                        ]
                      },
                      {
                        "$subtract": [
                          0,
                          "$amount"
                        ]
                      },
                      "$amount"
                    ]
                  }
                },
                "currency": {
                  "$first": "$currency"
                }
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "paysuper_method_refund_fee_tariff_profit"
        }
      },
      {
        "$unwind": {
          "path": "$paysuper_method_refund_fee_tariff_profit",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": {
                  "$in": [
                    "merchant_refund_fixed_fee",
                    "real_refund_fixed_fee"
                  ]
                }
              }
            },
            {
              "$group": {
                "_id": "$currency",
                "amount": {
                  "$sum": {
                    "$cond": [
                      {
                        "$eq": [
                          "$type",
                          "real_refund_fixed_fee"
                        ]
                      },
                      {
                        "$subtract": [
                          0,
                          "$amount"
                        ]
                      },
                      "$amount"
                    ]
                  }
                },
                "currency": {
                  "$first": "$currency"
                }
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "paysuper_method_refund_fixed_fee_tariff_profit"
        }
      },
      {
        "$unwind": {
          "path": "$paysuper_method_refund_fixed_fee_tariff_profit",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": {
                  "$in": [
                    "real_gross_revenue",
                    "merchant_tax_fee_central_bank_fx",
                    "ps_gross_revenue_fx",
                    "merchant_tax_fee_cost_value",
                    "ps_method_fee",
                    "merchant_ps_fixed_fee"
                  ]
                }
              }
            },
            {
              "$group": {
                "_id": "$currency",
                "amount": {
                  "$sum": {
                    "$cond": [
                      {
                        "$in": [
                          "$type",
                          [
                            "ps_gross_revenue_fx",
                            "merchant_tax_fee_central_bank_fx",
                            "merchant_tax_fee_cost_value",
                            "ps_method_fee",
                            "merchant_ps_fixed_fee"
                          ]
                        ]
                      },
                      {
                        "$subtract": [
                          0,
                          "$amount"
                        ]
                      },
                      "$amount"
                    ]
                  }
                },
                "currency": {
                  "$first": "$currency"
                }
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "net_revenue"
        }
      },
      {
        "$unwind": {
          "path": "$net_revenue",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": {
                  "$in": [
                    "ps_method_fee",
                    "merchant_ps_fixed_fee",
                    "merchant_method_fee_cost_value",
                    "real_merchant_method_fixed_fee_cost_value"
                  ]
                }
              }
            },
            {
              "$group": {
                "_id": "$currency",
                "amount": {
                  "$sum": {
                    "$cond": [
                      {
                        "$in": [
                          "$type",
                          [
                            "merchant_method_fee_cost_value",
                            "real_merchant_method_fixed_fee_cost_value"
                          ]
                        ]
                      },
                      {
                        "$subtract": [
                          0,
                          "$amount"
                        ]
                      },
                      "$amount"
                    ]
                  }
                },
                "currency": {
                  "$first": "$currency"
                }
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "paysuper_method_total_profit"
        }
      },
      {
        "$unwind": {
          "path": "$paysuper_method_total_profit",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": {
                  "$in": [
                    "ps_gross_revenue_fx",
                    "ps_method_fee",
                    "merchant_ps_fixed_fee",
                    "central_bank_tax_fee",
                    "ps_gross_revenue_fx_tax_fee",
                    "merchant_method_fee_cost_value",
                    "real_merchant_method_fixed_fee_cost_value"
                  ]
                }
              }
            },
            {
              "$group": {
                "_id": "$currency",
                "amount": {
                  "$sum": {
                    "$cond": [
                      {
                        "$in": [
                          "$type",
                          [
                            "central_bank_tax_fee",
                            "ps_gross_revenue_fx_tax_fee",
                            "merchant_method_fee_cost_value",
                            "real_merchant_method_fixed_fee_cost_value"
                          ]
                        ]
                      },
                      {
                        "$subtract": [
                          0,
                          "$amount"
                        ]
                      },
                      "$amount"
                    ]
                  }
                },
                "currency": {
                  "$first": "$currency"
                }
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "paysuper_total_profit"
        }
      },
      {
        "$unwind": {
          "path": "$paysuper_total_profit",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": {
                  "$in": [
                    "merchant_refund",
                    "merchant_refund_fee",
                    "merchant_refund_fixed_fee",
                    "reverse_tax_fee_delta",
                    "reverse_tax_fee"
                  ]
                }
              }
            },
            {
              "$group": {
                "_id": "$currency",
                "amount": {
                  "$sum": {
                    "$cond": [
                      {
                        "$eq": [
                          "$type",
                          "reverse_tax_fee"
                        ]
                      },
                      {
                        "$subtract": [
                          0,
                          "$amount"
                        ]
                      },
                      "$amount"
                    ]
                  }
                },
                "currency": {
                  "$first": "$currency"
                }
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "refund_reverse_revenue"
        }
      },
      {
        "$unwind": {
          "path": "$refund_reverse_revenue",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$lookup": {
          "from": "accounting_entry",
          "let": {
            "order_id": "$_id",
            "object_type": "$type"
          },
          "pipeline": [
            {
              "$match": {
                "$expr": {
                  "$and": [
                    {
                      "$eq": [
                        "$source.id",
                        "$$order_id"
                      ]
                    },
                    {
                      "$eq": [
                        "$source.type",
                        "$$object_type"
                      ]
                    }
                  ]
                },
                "type": {
                  "$in": [
                    "merchant_refund_fee",
                    "merchant_refund_fixed_fee",
                    "ps_reverse_tax_fee_delta",
                    "real_refund_fixed_fee",
                    "real_refund_fee"
                  ]
                }
              }
            },
            {
              "$group": {
                "_id": "$currency",
                "amount": {
                  "$sum": {
                    "$cond": [
                      {
                        "$in": [
                          "$type",
                          [
                            "real_refund_fixed_fee",
                            "real_refund_fee"
                          ]
                        ]
                      },
                      {
                        "$subtract": [
                          0,
                          "$amount"
                        ]
                      },
                      "$amount"
                    ]
                  }
                },
                "currency": {
                  "$first": "$currency"
                }
              }
            },
            {
              "$project": {
                "amount": 1,
                "currency": 1,
                "_id": 0
              }
            }
          ],
          "as": "paysuper_refund_total_profit"
        }
      },
      {
        "$unwind": {
          "path": "$paysuper_refund_total_profit",
          "preserveNullAndEmptyArrays": true
        }
      },
      {
        "$project": {
          "_id": 1,
          "uuid": 1,
          "pm_order_id": 1,
          "project": 1,
          "created_at": 1,
          "pm_order_close_date": 1,
          "total_payment_amount": 1,
          "currency": 1,
          "user": 1,
          "billing_address": 1,
          "payment_method": 1,
          "country": {
            "$cond": [
              {
                "$ne": [
                  "$billing_address",
                  null
                ]
              },
              "$billing_address.country",
              "$user.address.country"
            ]
          },
          "locale": {
            "$cond": [
              {
                "$ne": [
                  "$user",
                  null
                ]
              },
              "$user.locale",
              ""
            ]
          },
          "type": 1,
          "is_vat_deduction": 1,
          "payment_gross_revenue_local": 1,
          "payment_gross_revenue_origin": 1,
          "payment_gross_revenue": 1,
          "payment_tax_fee": 1,
          "payment_tax_fee_local": 1,
          "payment_tax_fee_origin": 1,
          "payment_tax_fee_current_exchange_fee": 1,
          "payment_tax_fee_total": 1,
          "payment_gross_revenue_fx": 1,
          "payment_gross_revenue_fx_tax_fee": 1,
          "payment_gross_revenue_fx_profit": 1,
          "gross_revenue": 1,
          "tax_fee": 1,
          "tax_fee_currency_exchange_fee": 1,
          "tax_fee_total": 1,
          "method_fee_total": 1,
          "method_fee_tariff": 1,
          "paysuper_method_fee_tariff_self_cost": 1,
          "paysuper_method_fee_profit": 1,
          "method_fixed_fee_tariff": 1,
          "paysuper_method_fixed_fee_tariff_fx_profit": 1,
          "paysuper_method_fixed_fee_tariff_self_cost": 1,
          "paysuper_method_fixed_fee_tariff_total_profit": 1,
          "paysuper_fixed_fee": 1,
          "paysuper_fixed_fee_fx_profit": 1,
          "fees_total": 1,
          "net_revenue": 1,
          "paysuper_method_total_profit": 1,
          "paysuper_total_profit": 1,
          "payment_refund_gross_revenue_local": 1,
          "payment_refund_gross_revenue_origin": 1,
          "payment_refund_gross_revenue": 1,
          "payment_refund_tax_fee": 1,
          "payment_refund_tax_fee_local": 1,
          "payment_refund_tax_fee_origin": 1,
          "payment_refund_fee_tariff": 1,
          "method_refund_fixed_fee_tariff": 1,
          "refund_gross_revenue": 1,
          "refund_gross_revenue_fx": 1,
          "method_refund_fee_tariff": 1,
          "paysuper_method_refund_fee_tariff_profit": 1,
          "paysuper_method_refund_fixed_fee_tariff_self_cost": 1,
          "merchant_refund_fixed_fee_tariff": 1,
          "paysuper_method_refund_fixed_fee_tariff_profit": 1,
          "refund_tax_fee": 1,
          "refund_tax_fee_currency_exchange_fee": 1,
          "paysuper_refund_tax_fee_currency_exchange_fee": 1,
          "refund_tax_fee_total": 1,
          "refund_reverse_revenue": 1,
          "refund_fees_total": 1,
          "paysuper_refund_total_profit": 1
        }
      },
      {
        "$project": {
          "payment_method.params": 0,
          "payment_method.payment_system_id": 0
        }
      }
    ]
  }
]